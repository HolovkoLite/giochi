<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Logica Facile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fdfaf6;
            color: #34495e;
        }
        .section { display: none; }
        .section.active { display: block; }

        /* Stile Bottoni e Card */
        .btn-primary {
            background-image: linear-gradient(to right, #1abc9c, #16a085);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(22, 160, 133, 0.35);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(22, 160, 133, 0.5);
        }
        .card-link {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-link:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px -8px rgba(0,0,0,0.2);
        }

        /* Stili Accordion */
        .accordion-toggle {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .accordion-toggle.active, .accordion-toggle:hover {
            background-color: #e8f8f5;
        }
        .accordion-toggle.active .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background-color: #fdfdfd;
        }

        /* Stili Esercizio */
        .syntagm {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }
        .syntagm:hover {
            background-color: #e0f2fe;
            border-color: #3498db;
        }
        .syntagm.analyzed {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #ecf0f1;
            text-decoration: line-through;
        }
        .syntagm.selected {
            background-color: #aed6f1;
            border-color: #2980b9;
            transform: scale(1.05);
        }
        .syntagm.error {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            opacity: 0.7;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header e Navigazione -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 to-cyan-500">Analisi Logica Facile</h1>
            <div class="flex space-x-4 md:space-x-6 text-lg">
                <a href="#home" class="nav-link text-gray-600 hover:text-teal-600 font-bold">Home</a>
                <a href="#guida" class="nav-link text-gray-600 hover:text-teal-600 font-bold">Guida</a>
                <a href="#teoria" class="nav-link text-gray-600 hover:text-teal-600 font-bold">Teoria</a>
                <a href="#esercizi" class="nav-link text-gray-600 hover:text-teal-600 font-bold">Esercizi</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6 md:p-8">

        <!-- Sezioni del sito (Home, Guida, Teoria) -->
        <section id="home" class="section active text-center">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Benvenuto/a!</h2>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto mb-8">
                    Pronto/a a diventare un campione di analisi logica? Scegli da dove iniziare!
                </p>
                <div class="grid md:grid-cols-3 gap-6">
                    <a href="#guida" class="nav-link card-link block bg-orange-100 p-6 rounded-lg text-center">
                        <i class="fas fa-map-signs text-4xl text-orange-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-orange-800">La Guida</h3>
                        <p class="text-orange-700">Impara il metodo in 4 semplici passi.</p>
                    </a>
                    <a href="#teoria" class="nav-link card-link block bg-sky-100 p-6 rounded-lg text-center">
                        <i class="fas fa-book-open text-4xl text-sky-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-sky-800">La Teoria</h3>
                        <p class="text-sky-700">Ripassa tutti gli elementi della frase.</p>
                    </a>
                    <a href="#esercizi" class="nav-link card-link block bg-teal-100 p-6 rounded-lg text-center">
                        <i class="fas fa-pencil-alt text-4xl text-teal-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-teal-800">Gli Esercizi</h3>
                        <p class="text-teal-700">Mettiti alla prova e impara giocando.</p>
                    </a>
                </div>
            </div>
        </section>

        <section id="guida" class="section">
             <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-teal-200 pb-2">I 4 Passaggi per un'Analisi Perfetta</h2>
                <div class="space-y-8">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-12 w-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">1</div>
                        <div class="ml-4">
                            <h3 class="text-2xl font-semibold text-gray-700">Dividi la frase in sintagmi</h3>
                            <p class="mt-1 text-gray-600">Il primo passo è "spezzare" la frase nei suoi mattoncini fondamentali. Un sintagma è un gruppo di parole con un senso logico. Di solito, articoli, aggettivi e preposizioni si legano al nome a cui si riferiscono. <strong>Attenzione:</strong> un complemento di specificazione (es. "di Maria") è un sintagma separato dal nome a cui si lega (es. "Il gatto").</p>
                            <p class="mt-2 text-sm text-gray-500 italic">Esempio: "Il gatto / di mia zia / dorme / sul divano."</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-12 w-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">2</div>
                        <div class="ml-4">
                            <h3 class="text-2xl font-semibold text-gray-700">Trova il predicato</h3>
                            <p class="mt-1 text-gray-600">Il predicato è il cuore della frase, l'azione. Chiediti: "Cosa succede? Che azione viene compiuta?". Il predicato è sempre un verbo.</p>
                             <p class="mt-2 text-sm text-gray-500 italic">Esempio: In "Luca / mangia / una mela", l'azione è "mangia".</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-12 w-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">3</div>
                        <div class="ml-4">
                            <h3 class="text-2xl font-semibold text-gray-700">Identifica il soggetto</h3>
                            <p class="mt-1 text-gray-600">Una volta trovato il predicato, chiediti: "Chi compie l'azione?". La risposta è il soggetto. Ricorda che a volte può essere sottinteso (non scritto ma facile da capire).</p>
                             <p class="mt-2 text-sm text-gray-500 italic">Esempio: In "Luca mangia una mela", chi mangia? "Luca". Lui è il soggetto.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-12 w-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">4</div>
                        <div class="ml-4">
                            <h3 class="text-2xl font-semibold text-gray-700">Analizza i complementi</h3>
                            <p class="mt-1 text-gray-600">Tutto ciò che rimane sono i complementi, che arricchiscono la frase. Per ognuno, poniti la domanda giusta: "Chi? Che cosa?" (Complemento Oggetto), "Dove?" (Complemento di Luogo), "Quando?" (Complemento di Tempo), e così via.</p>
                             <p class="mt-2 text-sm text-gray-500 italic">Esempio: In "Luca mangia una mela", cosa mangia? "una mela". È il complemento oggetto.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="teoria" class="section">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">La Teoria in Pillole</h2>
                <div class="space-y-4" id="accordion-container">
                    <!-- Accordion items will be injected here by JS -->
                </div>
            </div>
        </section>

        <section id="esercizi" class="section">
            <div id="password-screen" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Area Riservata</h2>
                <p class="text-gray-600 mb-6">Per accedere agli esercizi, inserisci la password fornita dal professore.</p>
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Scrivi qui la password...">
                <button id="password-submit" class="mt-4 w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Entra</button>
                <p id="password-error" class="text-red-500 mt-2 text-sm hidden">Password non corretta. Riprova.</p>
            </div>

            <div id="exercise-screen" class="hidden">
                <div id="difficulty-selection" class="text-center bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Scegli il livello di difficoltà</h2>
                    <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                        <button data-difficulty="Facile" class="btn-primary w-full md:w-auto text-white font-bold py-3 px-8 rounded-lg text-lg">Facile</button>
                        <button data-difficulty="Intermedio" class="btn-primary w-full md:w-auto text-white font-bold py-3 px-8 rounded-lg text-lg">Intermedio</button>
                        <button data-difficulty="Difficile" class="btn-primary w-full md:w-auto text-white font-bold py-3 px-8 rounded-lg text-lg">Difficile</button>
                    </div>
                </div>

                <div id="exercise-area" class="hidden mt-8 bg-white p-8 rounded-xl shadow-lg">
                    <div id="loading-spinner" class="text-center hidden">
                        <svg class="animate-spin h-10 w-10 text-teal-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600">Genero una frase per te...</p>
                    </div>
                    
                    <div id="game-content">
                        <div id="sentence-container" class="text-2xl md:text-3xl text-center font-medium p-6 bg-gray-100 rounded-lg mb-6 min-h-[80px] flex items-center justify-center flex-wrap gap-x-2"></div>
                        <div id="instruction-area" class="text-center mb-6">
                            <p id="instruction-text" class="text-xl font-semibold text-teal-700"></p>
                        </div>
                        <div id="choices-area" class="flex flex-wrap justify-center gap-3"></div>
                        <div id="result-area" class="hidden text-center mt-8">
                            <h3 id="result-title" class="text-3xl font-bold"></h3>
                            <p id="result-score" class="text-lg mt-2"></p>
                            <button id="new-game-button" class="mt-6 btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">Genera una nuova frase</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Modal per Errori -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-auto text-center">
            <div id="modal-message" class="text-gray-700 text-lg mb-6"></div>
            <button id="modal-close-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-lg">Ho capito</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATI TEORIA ---
            const theoryData = [
                {
                    title: 'Il Predicato',
                    content: `
                        <p class="mb-4">Il predicato è il <strong>cuore della frase</strong>, l'elemento che dice ("predica") qualcosa sul soggetto. È sempre un verbo e può essere di due tipi:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Predicato Verbale (PV):</strong> Indica un'azione compiuta o subita dal soggetto. È formato da un qualsiasi verbo di senso compiuto.
                                <ul class="list-disc list-inside ml-6 text-sm">
                                    <li>Esempio: "Luca <strong>corre</strong> nel parco." (Azione compiuta)</li>
                                    <li>Esempio: "La mela <strong>è stata mangiata</strong>." (Azione subita)</li>
                                </ul>
                            </li>
                            <li><strong>Predicato Nominale (PN):</strong> Indica un modo di essere o una caratteristica del soggetto. È sempre formato da:
                                <ul class="list-disc list-inside ml-6 text-sm">
                                    <li><strong>Copula:</strong> una voce del verbo 'essere'.</li>
                                    <li><strong>Nome del Predicato (o Parte Nominale):</strong> un aggettivo o un nome che completa il senso.</li>
                                    <li>Esempio: "Il cielo <strong>è azzurro</strong>." ('è' = copula, 'azzurro' = nome del predicato)</li>
                                    <li>Esempio: "Mio padre <strong>è un avvocato</strong>." ('è' = copula, 'un avvocato' = nome del predicato)</li>
                                </ul>
                            </li>
                        </ul>
                    `
                },
                {
                    title: 'Il Soggetto',
                    content: `
                        <p class="mb-4">Il soggetto è l'elemento della frase di cui il predicato dice qualcosa. Per trovarlo, dopo aver trovato il predicato, chiediti: <strong>"Chi/Che cosa compie/subisce l'azione?"</strong></p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Posizione:</strong> Di solito si trova prima del predicato, ma non sempre! Esempio: "<strong>È arrivata Maria</strong>".</li>
                            <li><strong>Soggetto Partitivo:</strong> Quando è introdotto da un articolo partitivo (del, dello, della, dei, degli, delle). Esempio: "<strong>Dei ragazzi</strong> giocano in cortile."</li>
                            <li><strong>Soggetto Sottinteso:</strong> Quando non è espresso nella frase, ma si capisce dal contesto o dal verbo. Esempio: "Andiamo al mare." (Soggetto sottinteso: <strong>noi</strong>)</li>
                            <li><strong>Soggetto Mancante:</strong> Con i verbi impersonali (che indicano fenomeni atmosferici o sensazioni) il soggetto non c'è. Esempio: "Piove.", "Bisogna studiare."</li>
                        </ul>
                    `
                },
                {
                    title: 'Attributo e Apposizione',
                    content: `
                        <p class="mb-4">Sono elementi che si aggiungono a un nome (soggetto o complemento) per arricchirlo di informazioni.</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Attributo:</strong> È un <strong>aggettivo</strong> che accompagna un nome per specificarne una qualità.
                                <ul class="list-disc list-inside ml-6 text-sm">
                                    <li>Esempio: "Ho visto un film <strong>divertente</strong>." ('divertente' è attributo del complemento oggetto 'un film')</li>
                                    <li>Esempio: "La <strong>tua</strong> bicicletta è nuova." ('tua' è attributo del soggetto 'bicicletta')</li>
                                </ul>
                            </li>
                            <li><strong>Apposizione:</strong> È un <strong>nome</strong> che si affianca a un altro nome per definirlo meglio.
                                <ul class="list-disc list-inside ml-6 text-sm">
                                    <li>Esempio: "Il fiume <strong>Po</strong> attraversa la pianura." ('Po' è apposizione del soggetto 'il fiume')</li>
                                    <li>Esempio: "Ho parlato con il dottor <strong>Rossi</strong>." ('Rossi' è apposizione del complemento 'il dottore')</li>
                                </ul>
                            </li>
                        </ul>
                    `
                },
                {
                    title: 'I Complementi',
                    content: `
                        <p class="mb-4">I complementi arricchiscono la frase con informazioni aggiuntive. Per riconoscerli, devi porti la domanda giusta! Qui sotto trovi un elenco completo. Usa la barra di ricerca per trovare un complemento per nome o per domanda.</p>
                        <input type="search" id="complement-search" placeholder="Cerca un complemento (es. 'di specificazione' o 'dove?')" class="w-full p-2 border border-gray-300 rounded-md mb-4">
                        <div id="complements-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    `
                }
            ];

            const complementsList = [
                { name: "COMPLEMENTO OGGETTO", question: "Chi? Che cosa?", example: "Marco mangia <strong>una mela</strong>." },
                { name: "COMPLEMENTO DI SPECIFICAZIONE", question: "Di chi? Di che cosa?", example: "La bici <strong>di Luca</strong> è rossa." },
                { name: "COMPLEMENTO DI TERMINE", question: "A chi? A che cosa?", example: "Ho telefonato <strong>a mia nonna</strong>." },
                { name: "COMPLEMENTO D'AGENTE", question: "Da chi?", example: "Il ladro fu arrestato <strong>dai carabinieri</strong>." },
                { name: "COMPLEMENTO DI CAUSA EFFICIENTE", question: "Da che cosa?", example: "L'albero è stato abbattuto <strong>dal fulmine</strong>." },
                { name: "COMPLEMENTO DI CAUSA", question: "Per quale causa/motivo?", example: "Tremo <strong>dal freddo</strong>." },
                { name: "COMPLEMENTO DI FINE O SCOPO", question: "Per quale fine/scopo?", example: "Studio <strong>per la promozione</strong>." },
                { name: "COMPLEMENTO DI MEZZO O STRUMENTO", question: "Per mezzo di chi/che cosa?", example: "Scrivo <strong>con la penna</strong>." },
                { name: "COMPLEMENTO DI MODO O MANIERA", question: "Come? In che modo?", example: "Cammina <strong>con lentezza</strong>." },
                { name: "COMPLEMENTO DI COMPAGNIA E UNIONE", question: "Con chi? Con che cosa?", example: "Esco <strong>con gli amici</strong>." },
                { name: "COMPLEMENTO DI STATO IN LUOGO", question: "Dove?", example: "Sono <strong>a casa</strong>." },
                { name: "COMPLEMENTO DI MOTO A LUOGO", question: "Verso dove?", example: "Vado <strong>a scuola</strong>." },
                { name: "COMPLEMENTO DI MOTO DA LUOGO", question: "Da dove?", example: "Torno <strong>da Roma</strong>." },
                { name: "COMPLEMENTO DI MOTO PER LUOGO", question: "Attraverso dove?", example: "Passo <strong>per il parco</strong>." },
                { name: "COMPLEMENTO DI TEMPO DETERMINATO", question: "Quando?", example: "Ci vediamo <strong>domani</strong>." },
                { name: "COMPLEMENTO DI TEMPO CONTINUATO", question: "Per quanto tempo?", example: "Ha piovuto <strong>per tre giorni</strong>." },
                { name: "COMPLEMENTO DI ARGOMENTO", question: "Su quale argomento?", example: "Parliamo <strong>di calcio</strong>." },
                { name: "COMPLEMENTO DI MATERIA", question: "Fatto di che cosa?", example: "Una statua <strong>di marmo</strong>." },
                { name: "COMPLEMENTO DI QUALITÀ", question: "Con quali qualità?", example: "Un ragazzo <strong>dagli occhi azzurri</strong>." },
                { name: "COMPLEMENTO PARTITIVO", question: "Tra chi? Tra che cosa?", example: "<strong>Uno di voi</strong> deve parlare." },
                { name: "COMPLEMENTO DI PARAGONE", question: "Più/meno di chi/che cosa?", example: "Sei più alto <strong>di me</strong>." },
                { name: "COMPLEMENTO DI ETÀ", question: "Di quanti anni?", example: "Un bambino <strong>di sei anni</strong>." },
                { name: "COMPLEMENTO DI ABBONDANZA", question: "Pieno di che cosa?", example: "Un cesto pieno <strong>di funghi</strong>." },
                { name: "COMPLEMENTO DI PRIVAZIONE", question: "Privo di che cosa?", example: "Un uomo privo <strong>di scrupoli</strong>." },
                { name: "COMPLEMENTO DI ESCLUSIONE", question: "Senza chi/che cosa?", example: "Caffè <strong>senza zucchero</strong>." },
                { name: "COMPLEMENTO CONCESSIVO", question: "Nonostante che cosa?", example: "È uscito <strong>nonostante la pioggia</strong>." },
                { name: "COMPLEMENTO DI VANTAGGIO/SVANTAGGIO", question: "A vantaggio/svantaggio di chi?", example: "Lavoro <strong>per te</strong>. / Questo va <strong>a tuo danno</strong>." }
            ];

            // --- GESTIONE NAVIGAZIONE E UI ---
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');
            const accordionContainer = document.getElementById('accordion-container');

            function showSection(id) {
                sections.forEach(section => section.classList.toggle('active', section.id === id));
                window.scrollTo(0, 0);
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.closest('a').getAttribute('href').substring(1);
                    showSection(targetId);
                });
            });

            function setupTheorySection() {
                accordionContainer.innerHTML = theoryData.map(item => `
                    <div class="border border-gray-200 rounded-lg">
                        <button class="accordion-toggle w-full flex justify-between items-center p-4 text-left">
                            <span class="text-xl font-bold text-teal-700">${item.title}</span>
                            <i class="fas fa-chevron-down accordion-icon text-teal-500"></i>
                        </button>
                        <div class="accordion-content">
                            <div class="p-4 border-t border-gray-200">${item.content}</div>
                        </div>
                    </div>
                `).join('');

                document.querySelectorAll('.accordion-toggle').forEach(button => {
                    button.addEventListener('click', () => {
                        const content = button.nextElementSibling;
                        button.classList.toggle('active');
                        content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
                    });
                });
                
                if (document.getElementById('complement-search')) {
                    renderComplements();
                    document.getElementById('complement-search').addEventListener('input', (e) => renderComplements(e.target.value));
                }
            }
            
            function renderComplements(filter = '') {
                const listContainer = document.getElementById('complements-list');
                const filterText = filter.toLowerCase().trim();
                const filteredComplements = complementsList.filter(c => 
                    c.name.toLowerCase().includes(filterText) || 
                    c.question.toLowerCase().includes(filterText)
                );

                if (filteredComplements.length > 0) {
                    listContainer.innerHTML = filteredComplements.map(c => `
                        <div class="p-3 bg-gray-50 rounded-md border border-gray-200">
                            <strong class="text-gray-800">${c.name}</strong>
                            <p class="text-sm text-teal-600">Domanda: <em>${c.question}</em></p>
                            <p class="text-sm text-gray-600">Esempio: ${c.example}</p>
                        </div>
                    `).join('');
                } else {
                    listContainer.innerHTML = `<p class="text-center text-gray-500">Nessun complemento trovato.</p>`;
                }
            }

            showSection('home');
            setupTheorySection();

            // --- GESTIONE SEZIONE ESERCIZI ---
            const CORRECT_PASSWORD = "prova";
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordScreen = document.getElementById('password-screen');
            const exerciseScreen = document.getElementById('exercise-screen');
            const difficultySelection = document.getElementById('difficulty-selection');
            const exerciseArea = document.getElementById('exercise-area');
            const loadingSpinner = document.getElementById('loading-spinner');
            const sentenceContainer = document.getElementById('sentence-container');
            const instructionText = document.getElementById('instruction-text');
            const choicesArea = document.getElementById('choices-area');
            const resultArea = document.getElementById('result-area');
            const resultTitle = document.getElementById('result-title');
            const resultScore = document.getElementById('result-score');
            const newGameButton = document.getElementById('new-game-button');
            const gameContent = document.getElementById('game-content');
            const errorModal = document.getElementById('error-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            let currentDifficulty = 'Facile';
            let currentSentenceData = null;
            let currentStep = '';
            let score = 0;
            let totalQuestions = 0;
            let complementsToAnalyze = [];
            let currentComplementIndex = 0;
            let onModalCloseCallback = null;
            
            passwordSubmit.addEventListener('click', () => {
                if (passwordInput.value === CORRECT_PASSWORD) {
                    passwordScreen.classList.add('hidden');
                    exerciseScreen.classList.remove('hidden');
                } else {
                    document.getElementById('password-error').classList.remove('hidden');
                    passwordInput.value = '';
                }
            });
            passwordInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') passwordSubmit.click(); });

            difficultySelection.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    currentDifficulty = button.dataset.difficulty;
                    difficultySelection.classList.add('hidden');
                    exerciseArea.classList.remove('hidden');
                    startNewGame();
                });
            });
            
            newGameButton.addEventListener('click', () => {
                exerciseArea.classList.add('hidden');
                difficultySelection.classList.remove('hidden');
            });

            function showErrorModal(message, callback) {
                modalMessage.innerHTML = message;
                errorModal.classList.remove('hidden');
                errorModal.classList.add('flex');
                onModalCloseCallback = callback;
            }

            function hideErrorModal() {
                errorModal.classList.add('hidden');
                errorModal.classList.remove('flex');
                if (typeof onModalCloseCallback === 'function') {
                    onModalCloseCallback();
                    onModalCloseCallback = null;
                }
            }
            modalCloseBtn.addEventListener('click', hideErrorModal);

            async function startNewGame() {
                resultArea.classList.add('hidden');
                gameContent.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                
                try {
                    const sentenceData = await generateSentenceWithAnalysis(currentDifficulty);
                    currentSentenceData = sentenceData;
                    score = 0;
                    
                    let questions = 1 + 1 + sentenceData.complements.length;
                    if (currentSentenceData.predicate.type === 'predicato_nominale' || currentSentenceData.predicate.type === 'predicato_verbale') {
                        questions++;
                    }
                    totalQuestions = questions;
                    
                    complementsToAnalyze = [...sentenceData.complements];
                    currentComplementIndex = 0;
                    
                    displaySentence();
                    startPredicateStep();
                } catch (error) {
                    console.error("Errore durante la generazione della frase:", error);
                    instructionText.textContent = "Oops! Qualcosa è andato storto. Riprova.";
                } finally {
                    loadingSpinner.classList.add('hidden');
                    gameContent.classList.remove('hidden');
                }
            }
            
            function displaySentence() {
                sentenceContainer.innerHTML = '';
                currentSentenceData.syntagms.forEach((syntagm, index) => {
                    const span = document.createElement('span');
                    span.textContent = syntagm.text;
                    span.className = 'syntagm m-1 inline-block';
                    span.dataset.index = index;
                    span.addEventListener('click', (e) => handleSyntagmClick(e.target));
                    sentenceContainer.appendChild(span);
                });
            }

            function handleSyntagmClick(target) {
                if (target.classList.contains('analyzed')) return;
                const clickedIndex = parseInt(target.dataset.index);
                const clickedSyntagm = currentSentenceData.syntagms[clickedIndex];

                if (currentStep === 'find_predicate') {
                    if (clickedSyntagm.role === 'predicato') {
                        score++;
                        target.classList.add('analyzed');
                        startPredicateTypeStep();
                    } else {
                        target.classList.add('error');
                        showErrorModal("Non esattamente. Ricorda, il <strong>predicato</strong> è il verbo, l'azione della frase. Cerca la parola che descrive 'cosa succede'.", () => {
                           target.classList.remove('error');
                        });
                    }
                } else if (currentStep === 'find_subject') {
                    if (clickedSyntagm.role === 'soggetto') {
                        score++;
                        target.classList.add('analyzed');
                        startComplementsStep();
                    } else {
                        target.classList.add('error');
                        const predicateText = `<strong>${currentSentenceData.predicate.text}</strong>`;
                        showErrorModal(`Non è questo il soggetto. Chiediti: "chi compie l'azione di ${predicateText}?". Riprova.`, () => {
                            target.classList.remove('error');
                        });
                    }
                }
            }

            function startPredicateStep() {
                currentStep = 'find_predicate';
                instructionText.textContent = "1. Clicca sul sintagma che contiene il PREDICATO.";
                choicesArea.innerHTML = '';
            }
            
            function startPredicateTypeStep() {
                currentStep = 'predicate_type';
                instructionText.textContent = "2. Il predicato che hai trovato è verbale o nominale?";
                choicesArea.innerHTML = `
                    <button class="btn-primary text-white font-bold py-2 px-4 rounded" onclick="checkPredicateType('predicato_verbale')">Verbale</button>
                    <button class="btn-primary text-white font-bold py-2 px-4 rounded" onclick="checkPredicateType('predicato_nominale')">Nominale</button>
                `;
            }
            
            window.checkPredicateType = function(chosenType) {
                if (chosenType === currentSentenceData.predicate.type) {
                    score++;
                    startSubjectStep();
                } else {
                    const correctType = currentSentenceData.predicate.type.replace(/_/g, ' ');
                    const explanation = `Risposta non corretta. In questo caso era un <strong>${correctType}</strong>. Un predicato verbale esprime un'azione, mentre uno nominale (con il verbo essere) descrive com'è o chi è il soggetto.`;
                    showErrorModal(explanation, startSubjectStep);
                }
            }

            function startSubjectStep() {
                currentStep = 'find_subject';
                instructionText.textContent = "3. Ora, clicca sul SOGGETTO. Se non è espresso, usa il pulsante.";
                choicesArea.innerHTML = `<button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" id="no-subject-btn">Soggetto Sottinteso</button>`;
                document.getElementById('no-subject-btn').onclick = () => {
                    if (currentSentenceData.subject.is_implied) {
                        score++;
                        startComplementsStep();
                    } else {
                        showErrorModal('Attenzione, in questa frase il soggetto è espresso! Cercalo nella frase.', () => {});
                    }
                };
            }

            function startComplementsStep() {
                currentStep = 'analyze_complements';
                if (currentComplementIndex < complementsToAnalyze.length) {
                    const complement = complementsToAnalyze[currentComplementIndex];
                    instructionText.textContent = `4. Che cos'è il sintagma "${complement.text}"?`;
                    document.querySelectorAll('.syntagm').forEach(span => {
                        span.classList.toggle('selected', span.textContent === complement.text);
                    });
                    displayComplementChoices(complement);
                } else {
                    showFinalResult();
                }
            }

            function displayComplementChoices(complement) {
                choicesArea.innerHTML = '';
                generateComplementOptions(complement.type).forEach(option => {
                    const btn = document.createElement('button');
                    btn.textContent = option.replace(/_/g, ' ');
                    btn.className = 'btn-primary text-white font-bold py-2 px-4 rounded capitalize';
                    btn.onclick = () => checkComplement(option, complement);
                    choicesArea.appendChild(btn);
                });
            }

            function checkComplement(chosenType, correctComplement) {
                const syntagmSpan = Array.from(document.querySelectorAll('.syntagm')).find(s => s.textContent === correctComplement.text);
                
                const advanceToNext = () => {
                    if(syntagmSpan) {
                        syntagmSpan.classList.add('analyzed');
                        syntagmSpan.classList.remove('selected', 'error');
                    }
                    currentComplementIndex++;
                    startComplementsStep();
                };

                if (chosenType === correctComplement.type) {
                    score++;
                    advanceToNext();
                } else {
                    if(syntagmSpan) syntagmSpan.classList.add('error');
                    const correctDetails = complementsList.find(c => c.name.toLowerCase().replace(/ /g, '_') === correctComplement.type);
                    const correctQuestion = correctDetails ? correctDetails.question : '';
                    const correctTypeName = correctComplement.type.replace(/_/g, ' ');
                    
                    let explanation = `Non esattamente. Il sintagma "<strong>${correctComplement.text}</strong>" è un <strong>${correctTypeName}</strong>`;
                    if (correctQuestion) {
                        explanation += `, perché risponde alla domanda "<strong>${correctQuestion}</strong>"`;
                    }
                    explanation += '.';
                    showErrorModal(explanation, advanceToNext);
                }
            }
            
            function generateComplementOptions(correctType) {
                let options = [correctType];
                let distractors = complementsList.map(c => c.name.toLowerCase().replace(/ /g, '_')).filter(t => t !== correctType);
                for (let i = 0; i < 3; i++) {
                    if (distractors.length > 0) {
                        const randomIndex = Math.floor(Math.random() * distractors.length);
                        options.push(distractors.splice(randomIndex, 1)[0]);
                    }
                }
                return options.sort(() => Math.random() - 0.5);
            }

            function showFinalResult() {
                instructionText.textContent = "Analisi completata!";
                choicesArea.innerHTML = '';
                resultArea.classList.remove('hidden');
                if (score === totalQuestions) {
                    resultTitle.textContent = 'Congratulazioni! Analisi perfetta! 🥳';
                    resultTitle.className = 'text-3xl font-bold text-green-600';
                } else if (score > totalQuestions / 2) {
                    resultTitle.textContent = 'Ottimo lavoro! 👍';
                    resultTitle.className = 'text-3xl font-bold text-yellow-600';
                } else {
                    resultTitle.textContent = 'Puoi fare di meglio. Continua a provare! 💪';
                    resultTitle.className = 'text-3xl font-bold text-red-600';
                }
                resultScore.textContent = `Punteggio finale: ${score} su ${totalQuestions}`;
            }

            async function generateSentenceWithAnalysis(difficulty) {
                // ===================================================================================
                // IMPORTANTE: Per usare questo codice su un sito esterno (es. Google Sites),
                // devi inserire qui la tua API Key di Google AI Studio.
                // Puoi ottenerla gratuitamente da https://aistudio.google.com/app/apikey
                // ===================================================================================
                const apiKey = "AIzaSyCBbJfbYt7JIxBSruekrGEVX8MMljqVfws"; // <-- INSERISCI LA TUA API KEY QUI
                // ===================================================================================

                const prompt = `
                    Sei un esperto di grammatica italiana per studenti di scuola media.
                    Genera UNA frase in italiano e la sua analisi logica completa, adatta a un livello di difficoltà "${difficulty}".
                    
                    REGOLE FONDAMENTALI PER LA DIVISIONE IN SINTAGMI:
                    1.  **NON UNIRE MAI IL SOGGETTO E IL SUO COMPLEMENTO DI SPECIFICAZIONE.** Esempio: "Il gatto di Maria" VA DIVISO in due sintagmi: "Il gatto" e "di Maria". Questa è la regola più importante.
                    2.  Gli articoli e gli aggettivi devono rimanere uniti al nome a cui si riferiscono. Esempio: "Un bel maglione" è un unico sintagma.
                    3.  Le preposizioni articolate (del, al, dal, etc.) introducono un nuovo sintagma.

                    USA I SEGUENTI NOMI PER I COMPLEMENTI DI LUOGO: 'complemento_di_stato_in_luogo', 'complemento_di_moto_a_luogo', 'complemento_di_moto_da_luogo', 'complemento_di_moto_per_luogo'.

                    VARIA IL PIÙ POSSIBILE la struttura della frase, il soggetto, il verbo e i complementi. Evita frasi ripetitive. Sii creativo e usa un lessico ricco ma appropriato.

                    Fornisci la risposta ESCLUSIVAMENTE in formato JSON, seguendo questa struttura precisa. Non aggiungere testo o spiegazioni al di fuori del JSON.

                    {
                      "full_sentence": "La frase completa generata.",
                      "predicate": {
                        "text": "il testo del predicato",
                        "type": "predicato_verbale" o "predicato_nominale"
                      },
                      "subject": {
                        "text": "il testo del soggetto" o "sottinteso",
                        "is_implied": true o false
                      },
                      "syntagms": [
                        { "text": "primo sintagma", "role": "soggetto" o "predicato" o "complemento" },
                        ...
                      ],
                      "complements": [
                        { "text": "testo del complemento 1", "type": "complemento_oggetto" o "complemento_di_termine" etc. },
                        ...
                      ]
                    }
                `;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                let attempts = 0;
                while (attempts < 5) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const result = await response.json();
                        return JSON.parse(result.candidates[0].content.parts[0].text);
                    } catch (error) {
                        attempts++;
                        if (attempts >= 5) throw error;
                        await new Promise(res => setTimeout(res, Math.pow(2, attempts) * 100));
                    }
                }
            }
        });
    </script>
</body>
</html>
